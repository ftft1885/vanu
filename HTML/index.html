<!DOCTYPE html>
<html>
<head>
<title>test</title>
<meta charset="utf-8">
<link href="./CSS/index.css" rel="stylesheet" type="text/css"></link>
</head>
<body>
<div id="main_header"></div>
<div id="main_body">
	<div id="main_panel">
	<ul id="menu">
		<li id="menu_pools"><a href="#pools">服务池</a></li>
	</ul>
	</div>

	<div id="main_content"></div>
</div>
<div id="main_footer"></div>
<script src="js/jquery-min.js"></script>
<script src="js/underscore-1.3.1.js"></script>
<script src="js/backbone.js"></script>


<script type="text/template" id="pools_div">
<div id="content_header">
<span class="content_name"><%=name  %></span><span class="content_addnew"><a href="#pools/addnew">新建<%=name %></a></span>
</div>
<p class="content_introduction">
<%=introduction %>
</p>
<ul id="pools_list" class="content_list"> 
</ul>
</script>
<script type="text/template" id="pools_detail">
Protocal Layer : <%=protocol_layer %><br>
服务节点： <%=nodes %><br>
健康检查： <%=monitor %><br>
最长时间回复：<%=max_reply_time %><br>
</script>
<script type="text/template" id="add_new">
a add new div
</script>
<script>
//TODO:fix the collection fetch bug

window.nuvaRouter = Backbone.Router.extend({
	initialize	:	function(){
		console.log("router initial");
	},

	routes	:	{
		""			:	"index",
		":menu"		:	"poolsFunc",
		":menu/addnew"	:	"addNewFunc"
	},

	index		: function(){
		console.log("homepage");
	},
	addNewFunc	:	function(menu){
		console.log("addnew");
		switch(menu){
			case "pools"	:
				$('#main_content').append(new add_new_view().el);
				console.log(new add_new_view());
			break;
		}
	},
	poolsFunc	: function(menu){
		console.log("you click "+menu);
		$('#main_content').append(new pools_view().el);
	}
});

var add_new_view = Backbone.View.extend({
	tagName		:	'div',
	className	:	'add_new',
	template	:	_.template($('#add_new').html()),
	initialize	:	function(){
		this.render();
	},
	render		:	function(){
		this.$el.html(this.template());
		return this;
	}
});

var pools_detail = Backbone.View.extend({
	tagName		:	'li',
	template	:	_.template($('#pools_detail').html()),
	initialize	:	function(){
		console.log("detail initial");
		console.log(this.model.toJSON());
		this.render();
	},
	render		:	function(){
		this.$el.html(this.template(this.model.toJSON()));
		return this;
	}
});

var pool_model = Backbone.Model.extend({
	defaults	:	function(){
		return {
			protocol_layer	:	'undef',
			nodes			:	'undef',
			monitor			:	'ping',
			max_reply_time	:	30
		}
	},

	initialize	:	function(){
		console.log("pool_model initial");
	}
}); 

var one_pool = new pool_model({nodes:'sdfas'});
console.log(one_pool.toJSON());

var pool_collection = Backbone.Collection.extend({
	model	:	pool_model,
	url		:	'/data',
});

var pools = new pool_collection;

var pools_view = Backbone.View.extend({
	tagName		:	'div',
	template	:	_.template($('#pools_div').html()),
	initialize	:	function(){
		this.render();
		pools.bind('reset',this.addAll,this);
		pools.bind('add',this.addOne,this);
		pools.fetch();
	},
	addOne	:	function(one_pool_model){
		var view = new pools_detail({model:one_pool_model});
		$('#pools_list').append(view.el);
	},
	addAll	:	function(){
		pools.each(this.addOne);
	},
	events	:	{
		//"click"		:	"func"
	},
	func	:	function(){
		//pools.bind('all',function(e){console.log(e)});
		//pools.fetch({add:true});
		//console.log(pools);
		//console.log(pools.toJSON());
		$('#pools_list').append(new pools_detail().el);
	},
	render		:	function(){
		window.pools = new pool_collection;
		this.$el.html(this.template({
			name		:	'服务池',
			introduction:	'服务池管理服务节点的组。其基于负载平衡和会话保持标准，将流量传递到最适合的服务节点。'	
		}));
		return this;
	}
});
new nuvaRouter();
Backbone.history.start();
var menu_list = [];	


function ajax(url,callback)
{
	var xhr;
	if(window.XMLHttpRequest)
		xhr = new XMLHttpRequest();
	else
		xhr = new ActiveXObject("Microsoft.XMLHTTP");
	xhr.onreadystatechange = function()
	{
		if(xhr.readyState == 4)
			callback(xhr.responseText);
	}
	xhr.open("POST",url,true);
	xhr.send();
}
</script>
</body>
</html>

